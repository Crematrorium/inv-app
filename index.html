<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инвентаризация - Barcode Harvester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: #4e73df;
            color: white;
            padding: 15px;
            margin: -10px -10px 15px -10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .panel {
            background: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .panel-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #4e73df;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            margin: 5px 0;
            width: 100%;
        }
        
        .btn-primary {
            background: #4e73df;
            color: white;
        }
        
        .btn-success {
            background: #1cc88a;
            color: white;
        }
        
        .btn-danger {
            background: #e74a3b;
            color: white;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .scanned-item {
            border-left: 4px solid #4e73df;
            padding: 10px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #4e73df;
            color: #4e73df;
            font-weight: bold;
        }
        
        .compatibility-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Инвентаризация</h1>
    </div>

    <div id="compatibility-warning" class="compatibility-warning">
        <strong>Внимание:</strong> Ваш браузер может не поддерживать некоторые функции. Рекомендуется использовать современный браузер.
    </div>

    <div id="main-screen">
        <div class="panel">
            <div class="panel-title">Тип инвентаризации</div>
            <div>
                <input type="radio" name="inventoryType" id="byLocation" value="location" checked>
                <label for="byLocation">По местам хранения</label>
            </div>
            <div>
                <input type="radio" name="inventoryType" id="byNomenclature" value="nomenclature">
                <label for="byNomenclature">По номенклатуре</label>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-title">Выбор склада</div>
            <select class="form-control" id="warehouseSelect">
                <option value="ТВЗ">Склад основного товара ТВЗ</option>
                <option value="Электромаркет">Склад Электромаркет</option>
            </select>
        </div>
        
        <div class="panel">
            <div class="panel-title">Настройки подключения</div>
            <input type="text" class="form-control" id="serverIp" placeholder="IP-адрес сервера">
            <input type="number" class="form-control" id="serverPort" value="8765" placeholder="Порт сервера">
            <div>
                <input type="checkbox" id="useSecureProtocol">
                <label for="useSecureProtocol">Использовать безопасное соединение (WSS)</label>
            </div>
            <button class="btn btn-primary" id="testConnection">Проверить подключение</button>
        </div>
        
        <button class="btn btn-success" id="startInventory">Начать инвентаризацию</button>
    </div>

    <div id="scan-screen" class="hidden">
        <div class="tabs">
            <div class="tab active" data-tab="scan">Сканирование</div>
            <div class="tab" data-tab="scanned">Отсканировано (<span id="scannedCount">0</span>)</div>
        </div>
        
        <div id="scan-tab">
            <div class="panel">
                <div class="panel-title">Сканирование товара</div>
                <input type="text" class="form-control" id="barcodeInput" placeholder="Штрих-код товара" autocomplete="off">
                
                <div class="panel-title">Количество</div>
                <div style="display: flex; align-items: center;">
                    <button class="btn" id="decreaseQuantity" style="width: 50px;">-</button>
                    <input type="number" class="form-control" id="quantityInput" value="1" min="1" style="margin: 0 10px; text-align: center;">
                    <button class="btn" id="increaseQuantity" style="width: 50px;">+</button>
                </div>
                
                <button class="btn btn-success" id="addQuantity">Добавить количество</button>
                
                <div id="product-info" class="hidden">
                    <div class="panel-title">Информация о товаре</div>
                    <div class="product-info-content"></div>
                </div>
            </div>
        </div>
        
        <div id="scanned-tab" class="hidden">
            <div class="panel">
                <div class="panel-title">Отсканированные товары</div>
                <button class="btn btn-primary" id="exportCSV">Экспорт в CSV</button>
                <button class="btn btn-primary" id="exportNetwork">Отправить на сервер</button>
                
                <div id="scanned-items-list">
                    <p style="text-align: center; color: #999; padding: 20px;">Нет отсканированных товаров</p>
                </div>
            </div>
        </div>
        
        <button class="btn btn-danger" id="back-button" style="position: fixed; bottom: 20px; left: 20px; width: auto;">Назад</button>
    </div>

    <script>
        // Проверка совместимости
        function checkCompatibility() {
            var incompatible = false;
            var issues = [];
            
            if (typeof Storage === "undefined") {
                incompatible = true;
                issues.push("localStorage не поддерживается");
            }
            
            if (!window.JSON) {
                incompatible = true;
                issues.push("JSON не поддерживается");
            }
            
            if (incompatible) {
                document.getElementById('compatibility-warning').style.display = 'block';
                console.log("Проблемы совместимости: " + issues.join(", "));
            }
            
            return !incompatible;
        }
        
        // Инициализация данных
        var scannedItems = [];
        var currentProduct = null;
        var selectedWarehouse = 'ТВЗ';
        var isInEditMode = false;
        
        // Демо-данные номенклатуры
        var nomenclature = [
            { id: 1, code: '100001', barcode: '4601234567890', name: 'Смартфон Samsung Galaxy S21', stock: { 'ТВЗ': 50, 'Электромаркет': 25 }, reserved: 5, location: 'Секция A-1' },
            { id: 2, code: '100002', barcode: '4601234567891', name: 'Ноутбук Lenovo IdeaPad 5', stock: { 'ТВЗ': 30, 'Электромаркет': 15 }, reserved: 3, location: 'Секция B-2' },
            { id: 3, code: '100003', barcode: '4601234567892', name: 'Наушники Sony WH-1000XM4', stock: { 'ТВЗ': 20, 'Электромаркет': 10 }, reserved: 2, location: 'Секция C-3' },
            { id: 4, code: '100004', barcode: '4601234567893', name: 'Планшет Apple iPad Air', stock: { 'ТВЗ': 15, 'Электромаркет': 8 }, reserved: 1, location: 'Секция D-4' },
            { id: 5, code: '100005', barcode: '4601234567894', name: 'Умные часы Apple Watch Series 7', stock: { 'ТВЗ': 25, 'Электромаркет': 12 }, reserved: 4, location: 'Секция E-5' }
        ];
        
        // Проверка совместимости при загрузке
        if (!checkCompatibility()) {
            alert("В вашем браузере есть ограниченная поддержка некоторых функций. Приложение может работать некорректно.");
        }
        
        // Функции для работы с интерфейсом
        function showScreen(screenId) {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('scan-screen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        function showTab(tabId) {
            document.getElementById('scan-tab').classList.add('hidden');
            document.getElementById('scanned-tab').classList.add('hidden');
            document.getElementById(tabId).classList.remove('hidden');
            
            // Обновляем активную вкладку
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
        }
        
        // Обработчики событий
        document.getElementById('startInventory').addEventListener('click', function() {
            selectedWarehouse = document.getElementById('warehouseSelect').value;
            showScreen('scan-screen');
        });
        
        document.getElementById('back-button').addEventListener('click', function() {
            showScreen('main-screen');
        });
        
        document.querySelectorAll('.tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                showTab(this.getAttribute('data-tab'));
            });
        });
        
        document.getElementById('barcodeInput').addEventListener('change', processBarcode);
        
        document.getElementById('decreaseQuantity').addEventListener('click', function() {
            var quantityInput = document.getElementById('quantityInput');
            var value = parseInt(quantityInput.value) || 1;
            if (value > 1) quantityInput.value = value - 1;
        });
        
        document.getElementById('increaseQuantity').addEventListener('click', function() {
            var quantityInput = document.getElementById('quantityInput');
            var value = parseInt(quantityInput.value) || 1;
            quantityInput.value = value + 1;
        });
        
        document.getElementById('addQuantity').addEventListener('click', addQuantity);
        
        document.getElementById('exportCSV').addEventListener('click', exportToCSV);
        
        // Основные функции приложения
        function processBarcode() {
            var barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) return;
            
            // Поиск товара
            var product = null;
            for (var i = 0; i < nomenclature.length; i++) {
                if (nomenclature[i].barcode === barcode) {
                    product = nomenclature[i];
                    break;
                }
            }
            
            if (product) {
                displayProductInfo(product);
                currentProduct = product;
                addScannedItem(1);
            } else {
                currentProduct = {
                    id: Date.now(),
                    barcode: barcode,
                    code: 'Новый',
                    name: 'Неизвестный товар',
                    stock: { 'ТВЗ': 0, 'Электромаркет': 0 },
                    reserved: 0,
                    location: 'Не указано'
                };
                displayProductInfo(currentProduct);
                addScannedItem(1);
            }
            
            document.getElementById('barcodeInput').value = '';
        }
        
        function displayProductInfo(product) {
            var quantity = getCurrentQuantity(product);
            
            var infoHTML = [
                '<p><strong>Код:</strong> ' + product.code + '</p>',
                '<p><strong>Наименование:</strong> ' + product.name + '</p>',
                '<p><strong>Штрих-код:</strong> ' + product.barcode + '</p>',
                '<p><strong>Остаток на складе:</strong> ' + (product.stock[selectedWarehouse] || 0) + '</p>',
                '<p><strong>Забронировано:</strong> ' + product.reserved + '</p>',
                '<p><strong>Место хранения:</strong> ' + product.location + '</p>',
                '<p><strong>Текущее количество:</strong> ' + quantity + '</p>'
            ].join('');
            
            document.querySelector('.product-info-content').innerHTML = infoHTML;
            document.getElementById('product-info').classList.remove('hidden');
        }
        
        function getCurrentQuantity(product) {
            for (var i = 0; i < scannedItems.length; i++) {
                if (scannedItems[i].barcode === product.barcode) {
                    return scannedItems[i].quantity;
                }
            }
            return 0;
        }
        
        function addScannedItem(quantity) {
            if (!currentProduct) return;
            
            // Проверяем, есть ли уже такой товар
            var existingIndex = -1;
            for (var i = 0; i < scannedItems.length; i++) {
                if (scannedItems[i].barcode === currentProduct.barcode) {
                    existingIndex = i;
                    break;
                }
            }
            
            if (existingIndex !== -1) {
                scannedItems[existingIndex].quantity += quantity;
            } else {
                scannedItems.push({
                    id: currentProduct.id,
                    code: currentProduct.code,
                    barcode: currentProduct.barcode,
                    name: currentProduct.name,
                    quantity: quantity,
                    warehouse: selectedWarehouse,
                    location: currentProduct.location
                });
            }
            
            // Сохранение в localStorage
            if (typeof Storage !== "undefined") {
                localStorage.setItem('scannedItems', JSON.stringify(scannedItems));
            }
            
            updateScannedList();
            displayProductInfo(currentProduct);
        }
        
        function addQuantity() {
            if (!currentProduct) {
                alert('Сначала отсканируйте товар');
                return;
            }
            
            var quantity = parseInt(document.getElementById('quantityInput').value) || 1;
            if (quantity <= 0) {
                alert('Количество должно быть положительным числом');
                return;
            }
            
            if (isInEditMode) {
                // Редактирование существующей записи
                for (var i = 0; i < scannedItems.length; i++) {
                    if (scannedItems[i].barcode === currentProduct.barcode) {
                        scannedItems[i].quantity = quantity;
                        break;
                    }
                }
                isInEditMode = false;
                currentProduct = null;
            } else {
                addScannedItem(quantity);
            }
            
            document.getElementById('quantityInput').value = '1';
        }
        
        function updateScannedList() {
            var scannedList = document.getElementById('scanned-items-list');
            var countElement = document.getElementById('scannedCount');
            
            countElement.textContent = scannedItems.length;
            
            if (scannedItems.length === 0) {
                scannedList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Нет отсканированных товаров</p>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < scannedItems.length; i++) {
                var item = scannedItems[i];
                html += [
                    '<div class="scanned-item">',
                    '<div style="display: flex; justify-content: space-between;">',
                    '<div>',
                    '<strong>' + item.name + '</strong>',
                    '<div>Код: ' + item.code + ' | Штрих-код: ' + item.barcode + '</div>',
                    '<div>Количество: ' + item.quantity + ' | Склад: ' + item.warehouse + '</div>',
                    '<div>Расположение: ' + item.location + '</div>',
                    '</div>',
                    '<div>',
                    '<button onclick="editItem(\'' + item.barcode + '\')" style="background: #f6c23e; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px;">✎</button>',
                    '<button onclick="deleteItem(\'' + item.barcode + '\')" style="background: #e74a3b; color: white; border: none; padding: 5px 10px; border-radius: 3px;">✕</button>',
                    '</div>',
                    '</div>',
                    '</div>'
                ].join('');
            }
            
            scannedList.innerHTML = html;
        }
        
        function editItem(barcode) {
            for (var i = 0; i < scannedItems.length; i++) {
                if (scannedItems[i].barcode === barcode) {
                    var item = scannedItems[i];
                    
                    // Находим товар в номенклатуре
                    var product = null;
                    for (var j = 0; j < nomenclature.length; j++) {
                        if (nomenclature[j].barcode === barcode) {
                            product = nomenclature[j];
                            break;
                        }
                    }
                    
                    if (!product) {
                        product = item;
                    }
                    
                    currentProduct = product;
                    displayProductInfo(product);
                    document.getElementById('quantityInput').value = item.quantity;
                    isInEditMode = true;
                    
                    showTab('scan-tab');
                    break;
                }
            }
        }
        
        function deleteItem(barcode) {
            for (var i = 0; i < scannedItems.length; i++) {
                if (scannedItems[i].barcode === barcode) {
                    scannedItems.splice(i, 1);
                    break;
                }
            }
            
            // Сохранение в localStorage
            if (typeof Storage !== "undefined") {
                localStorage.setItem('scannedItems', JSON.stringify(scannedItems));
            }
            
            updateScannedList();
            
            if (currentProduct && currentProduct.barcode === barcode) {
                document.getElementById('product-info').classList.add('hidden');
                currentProduct = null;
            }
        }
        
        function exportToCSV() {
            if (scannedItems.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }
            
            // Создаем CSV содержимое
            var csvContent = "Код;Наименование;Количество;Штрих-код;Склад;Расположение\n";
            
            for (var i = 0; i < scannedItems.length; i++) {
                var item = scannedItems[i];
                csvContent += item.code + ';"' + item.name + '";' + item.quantity + ';' + item.barcode + ';' + item.warehouse + ';' + item.location + '\n';
            }
            
            // Создаем и скачиваем файл
            var blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement("a");
            var date = new Date().toISOString().slice(0, 10);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "инвентаризация_" + date + ".csv");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Загрузка сохраненных данных при запуске
        function loadSavedData() {
            if (typeof Storage === "undefined") return;
            
            try {
                var savedData = localStorage.getItem('scannedItems');
                var savedWarehouse = localStorage.getItem('selectedWarehouse');
                
                if (savedData) {
                    scannedItems = JSON.parse(savedData) || [];
                    updateScannedList();
                }
                
                if (savedWarehouse) {
                    document.getElementById('warehouseSelect').value = savedWarehouse;
                    selectedWarehouse = savedWarehouse;
                }
            } catch (e) {
                console.error("Ошибка при загрузке данных: ", e);
            }
        }
        
        // Инициализация при загрузке
        window.onload = function() {
            loadSavedData();
            
            // Сохранение выбранного склада при изменении
            document.getElementById('warehouseSelect').addEventListener('change', function() {
                selectedWarehouse = this.value;
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('selectedWarehouse', selectedWarehouse);
                }
            });
        };
    </script>
</body>
</html>
